# *created  "Mon Feb 14 08:46:21 2022" *by "Paul E. Black"
# *modified "Wed Feb 23 10:30:13 2022" *by "Paul E. Black"

# Generate the requested vulnerability test suite and check the result

# Usage:
help_message="$ tests/gen_and_check {py,cs,php}"

if [ $# != 1 ]
then
    echo expecting one command line argument
    echo $help_message
    exit -1
fi

lang=$1
# determine the name of the language directory (LD)
if [ $lang == py ]
then
    LD=Python
elif [ $lang == cs ]
then
    LD=Csharp
elif [ $lang == php ]
then
    LD=PHP
else
    echo unknown language: $lang
    exit -1
fi

# Time Stamp matches name that VTGS will choose for the TestSuite
#    note: since time may differ by a second, names may differ
TimeStamp=$(date +"%m-%d-%Y_%Hh%Mm%S")
# choose a name for Photo file, which captures the output
PF="TestPhoto_${TimeStamp}_${LD}_photo"
# choose a name for Check file, which captures diff outputs
CF="TestPhoto_${TimeStamp}_${LD}_check"

# run VTSG and capture its output (generation report)
echo running vtsg.py -l $lang ...
python3 vtsg.py -l $lang | tee ${PF} 2>&1

# guess what the TestSuite directory was named
TSD=$(ls -dt TestSuite_*/${LD} | head -1)
echo ${TSD}

# check that the outputs match
echo checking that outputs match | tee -a ${CF} > /dev/null # don't bother user
diff ${PF} tests/${LD}_photo | tee -a ${CF} 2>&1

# test directory, relative to the new TestSuite... directory
TDIR="../../tests"

# check that generated files match
echo checking that generated files match ... | tee -a ${CF}
(cd ${TSD};for f in $(find . -name "*.${lang}"); do cmp $f ${TDIR}/${LD}/$f;done) | tee -a ${CF} 2>&1

# check that the manifests match
echo checking manifests | tee -a ${CF}
(cd ${TSD};for m in $(find . -name "manifest.xml"); do echo $m;${TDIR}/cmp_manifests.py $m ${TDIR}/${LD}/$m;done) | tee -a ${CF} 2>&1

# end of gen_and_check
